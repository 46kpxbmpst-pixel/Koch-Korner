import React, { useEffect, useMemo, useRef, useState } from "react";

const DEMO_RECIPES = [
  {
    id: "handkaes",
    title: "üßÄ Handk√§s mit Musik",
    image: "https://images.unsplash.com/photo-1551218808-94e220e084d2?q=80&w=1200&auto=format&fit=crop",
    time: 120,
    category: "Vegetarisch",
    ingredients: [
      "200‚Äì240 g Handk√§se (z. B. Harzer K√§se)",
      "3 Zwiebeln",
      "8 EL Essig (Apfel- oder Wei√üweinessig empfohlen)",
      "4 EL √ñl (Raps- oder Sonnenblumen√∂l)",
      "4 EL Wasser",
      "Salz",
      "Pfeffer",
      "1 TL K√ºmmel (ganz oder gemahlen)",
    ],
    steps: [
      "Essig, √ñl und Wasser in einer Sch√ºssel verr√ºhren. Mit Salz und Pfeffer abschmecken.",
      "Zwiebeln sch√§len, halbieren und in feine Ringe oder W√ºrfel schneiden.",
      "Zwiebeln und K√ºmmel in die Marinade geben und gut durchmischen.",
      "Handk√§se in eine flache Schale legen und die Marinade dar√ºber gie√üen, sodass der K√§se gut bedeckt ist.",
      "Abgedeckt im K√ºhlschrank 1‚Äì2 Stunden (oder besser √ºber Nacht) ziehen lassen.",
      "Mit frischem Bauernbrot, Schwarzbrot oder Brezeln servieren.",
    ],
    notes: [
      "Die 'Musik' im Namen bezieht sich scherzhaft auf die akustischen Nebenwirkungen der Zwiebeln.",
      "Optional: Mit frischen Kr√§utern wie Schnittlauch oder Petersilie verfeinern.",
      "Besonders gut zu einem Apfelwein (Ebbelwoi) oder einem k√ºhlen Bier genie√üen.",
    ],
  },
];

const ALL_CATEGORIES = ["Alle", "Vegetarisch"];

function classNames(...c) {
  return c.filter(Boolean).join(" ");
}

export default function RezeptSeite() {
  const [query, setQuery] = useState("");
  const [category, setCategory] = useState("Alle");
  const [activeId, setActiveId] = useState(null);
  const [hideBar, setHideBar] = useState(false);
  const lastScroll = useRef(0);

  useEffect(() => {
    const onScroll = () => {
      const y = window.scrollY || 0;
      if (y > lastScroll.current && y > 24) setHideBar(true);
      else setHideBar(false);
      lastScroll.current = y;
    };
    window.addEventListener("scroll", onScroll, { passive: true });
    return () => window.removeEventListener("scroll", onScroll);
  }, []);

  const recipes = useMemo(() => {
    const q = query.trim().toLowerCase();
    return DEMO_RECIPES.filter((r) => {
      const matchesCategory = category === "Alle" || r.category === category;
      const hay = `${r.title} ${r.ingredients.join(" ")}`.toLowerCase();
      const matchesQuery = !q || hay.includes(q);
      return matchesCategory && matchesQuery;
    });
  }, [query, category]);

  return (
    <div className="min-h-screen bg-black text-neutral-100 relative">
      <div className={classNames("fixed left-0 right-0 top-0 z-50 transition-transform duration-300", hideBar ? "-translate-y-full" : "translate-y-0")}> 
        <div className="mx-auto max-w-6xl px-4 pt-5">
          <div className="backdrop-blur bg-white/5 border border-white/10 rounded-2xl shadow-lg">
            <div className="flex items-center gap-2 px-4 py-3">
              <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Suche nach Rezepten oder Zutaten‚Ä¶" className="w-full bg-transparent outline-none placeholder:text-neutral-400 text-neutral-100" />
            </div>
          </div>
          {/* Kategorie-Chips ohne Rahmen */}
          <div className="mt-3 overflow-x-auto scrollbar-thin scrollbar-thumb-neutral-700 rounded-2xl bg-transparent">
            <div className="flex gap-2 p-3">
              {ALL_CATEGORIES.map((c) => (
                <button
                  key={c}
                  onClick={() => setCategory(c)}
                  className={classNames(
                    "rounded-full px-4 py-2 text-sm border transition",
                    c === category
                      ? "bg-white text-black border-white"
                      : "bg-white/5 text-neutral-200 border-white/20 hover:border-white/40"
                  )}
                >
                  {c}
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      <div className="h-[180px]" />

      <main className="mx-auto max-w-6xl px-4 pb-24 relative z-0">
        <div className="columns-1 sm:columns-2 lg:columns-3 gap-4">
          {recipes.map((r) => (
            <article key={r.id} className="mb-4 break-inside-avoid cursor-pointer group" onClick={() => setActiveId(r.id)}>
              <div className="relative overflow-hidden rounded-2xl border border-white/10 bg-white/5 shadow-lg">
                <img src={r.image} alt={r.title} className="w-full h-auto object-cover" />
                <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                  <h3 className="text-base font-semibold leading-tight">{r.title}</h3>
                  <p className="mt-1 text-xs text-neutral-300">{r.category} ‚Ä¢ {r.time} Min.</p>
                </div>
              </div>
            </article>
          ))}
        </div>
      </main>

      {activeId && <RecipeModal recipe={DEMO_RECIPES.find((r) => r.id === activeId)!} onClose={() => setActiveId(null)} />}
    </div>
  );
}

function RecipeModal({ recipe, onClose }) {
  useEffect(() => {
    const onKey = (e) => e.key === "Escape" && onClose();
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [onClose]);

  return (
    <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur flex" onClick={onClose}>
      <div className="relative m-auto w-full max-w-5xl max-h-[92vh] overflow-y-auto rounded-2xl border border-white/10 bg-neutral-950" onClick={(e) => e.stopPropagation()}>
        <div className="sticky top-0 flex justify-between items-center border-b border-white/10 bg-neutral-950/95 px-4 py-3">
          <h2 className="text-lg font-semibold">{recipe.title}</h2>
          <button onClick={onClose} className="rounded-full border border-white/20 px-3 py-1 text-sm hover:border-white/40">Schlie√üen</button>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-4">
          <div className="overflow-hidden rounded-xl border border-white/10 bg-white/5">
            <img src={recipe.image} alt={recipe.title} className="w-full h-auto object-cover" />
          </div>
          <div>
            <p className="text-sm text-neutral-300 mb-2">Zubereitungszeit: ca. 10 Min aktiv, 2 Std gesamt</p>
            <h3 className="mt-4 mb-2 text-base font-semibold">Zutaten</h3>
            <ul className="list-disc list-inside text-sm text-neutral-200/90 space-y-1">{recipe.ingredients.map((it, i) => <li key={i}>{it}</li>)}</ul>
            <h3 className="mt-4 mb-2 text-base font-semibold">Zubereitung</h3>
            <ol className="list-decimal list-inside text-sm text-neutral-200/90 space-y-2">{recipe.steps.map((s, i) => <li key={i}>{s}</li>)}</ol>
            <h3 className="mt-4 mb-2 text-base font-semibold">Notizen</h3>
            <ul className="list-disc list-inside text-sm text-neutral-400 space-y-1">{recipe.notes.map((n, i) => <li key={i}>{n}</li>)}</ul>
          </div>
        </div>
      </div>
    </div>
  );
}
